#!/bin/sh

#
# simple script to get the IP address and to change the root password
#
# Requires: kbd-wrapper >= 1.2		## FROM obs://home:jw
#
oldkeymap=$(kbd -q)

cat <<EOF
Welcome to your ownCloud appliance!

As part of this initialization you will be asked to change a password.
Currently the keyboard layout it set to the layout ($oldkeymap).
You can type a few keys to test your keyboard layout - press Enter to continue.

EOF
echo -n "> "
read a

echo "Choose one of the keyboard layouts below."
echo "Enter languange name or map name - or press Enter to keep."
kbd -c "
Select your language [%s] > "

echo ""
echo "Next we need to change the password for the 'root' account."
echo "Please use a secure password!"
echo ""

while true; do 
  /usr/bin/passwd && break; 
  sleep 3; 
  echo -e "\n\nPlease try again:"; 
done

export LC_ALL=C
echo ""
echo "Thank you."
echo ""
DEV=`netstat -rn | grep '^0.0.0.0' | awk '{ print $8 }'`
IP=`/sbin/ifconfig $DEV | grep 'inet addr' | cut -d ':' -f 2 | cut -d ' ' -f 1`
echo "Please point your web browser to your IP address"
echo ""
echo "     $IP"
echo ""
echo "to start using ownCloud."
echo "Please note the steps in the README inside your ownCloud."
echo "Please consider enabling online updates by running 'enable-updates'."
echo "Enjoy!"

# CAUTION: Keep in sync with config.sh -- it suggests to run 'start'
#          when one of the *.orig files is present.
if [ -f /etc/motd.orig ] ; then \
  mv -f /etc/motd.orig /etc/motd
fi

if [ -f /etc/issue.orig ] ; then \
  mv -f /etc/issue.orig /etc/issue
fi
echo ""
echo ""

test -x /usr/bin/figlet && figlet -f script -W "$IP"

echo ""
echo ""
echo "You can log off with 'exit'."

